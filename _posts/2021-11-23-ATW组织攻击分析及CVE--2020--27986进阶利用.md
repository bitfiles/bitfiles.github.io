> 据绿盟科技微信公众号[文章](https://mp.weixin.qq.com/s/LDZQZF-nMCvPFZc6DqRuQw)称，黑客组织AgainstTheWest（简称“ATW”）针对暴露在公网上的SonarQube平台进行攻击，窃取了我国多家企业单位信息系统源代码，并在国外黑客论坛RaidForums上进行非法售卖



其实上面的信息已经不算是新闻了，早在多日以前便能够在圈子内听闻一些相关的信息。

在文章正式开始之前，也首先感谢一下帮助我的两位大佬:[@Sunin](https://twitter.com/Sunin2021)小姐姐 和 @不愿意透露身份的z神

按照公众号所述，ATW组织针对暴露在公网上的SonarQube平台进行攻击，窃取托管至平台的系统源代码。在文章中称:

> 攻击者很可能是通过API存在未授权访问漏洞，该系统在默认配置下, 未对其API接口进行任何访问控制，攻击者可以通过向系统发送特定的恶意数据包，不经身份认证即可通过互联网下载该系统审计过的程序源代码，构成源代码数据泄露风险。另外，SonarQube平台默认管理员凭据为弱口令（admin:admin），攻击者可直接登录后台获取该系统审计过的源代码。



事实如此吗？是的没错。攻击者的确使用了该系统的API未授权漏洞以及默认的弱口令密码，但是造成漏洞最大的原因是因为，少数网络安全人员并没有认识到此次漏洞的严重性。

首先让我们查看一下攻击者使用的漏洞关联:

[CNVD-2021-84502](https://www.cnvd.org.cn/flaw/show/CNVD-2021-84502)

![image-20211124124312909](../assets/2021-11-23-ATW%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8ACVE-2020-27986%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/image-20211124124312909.png)



[CVE-2020-27986](https://nvd.nist.gov/vuln/detail/CVE-2020-27986):

![image-20211124124521224](../assets/2021-11-23-ATW%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8ACVE-2020-27986%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/image-20211124124521224.png)



我们搜索了互联网上存在的资料，发现几乎所有的文章都指向了 ***api/settings/values*** 这个API接口，但是当我们对环境进行实践时候，发现问题不只是这样。

下面是 ***api/settings/values*** 接口中暴露的敏感信息:

![image-20211124125003000](../assets/2021-11-23-ATW%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8ACVE-2020-27986%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/image-20211124125003000.png)

该接口的确暴露了一些敏感信息，但是对于大多数厂商和安全从业者来说，这类信息的利用价值并不是很大，所以导致一些厂商不重视这个漏洞，甚至是忽略了。



但是如果是下面这样呢？

![image-20211124125513325](../assets/2021-11-23-ATW%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8ACVE-2020-27986%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/image-20211124125513325.png)

![image-20211124125815893](../assets/2021-11-23-ATW%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8ACVE-2020-27986%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/image-20211124125815893.png)

![image-20211124141516465](../assets/2021-11-23-ATW%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90%E5%8F%8ACVE-2020-27986%E8%BF%9B%E9%98%B6%E5%88%A9%E7%94%A8/image-20211124141516465.png)



没错，就如AgainstTheWest所做的那样，我获取了你们托管在平台上所有的源代码、邮箱、配置文件。



ShowTime结束了，那么我们简单说说这个漏洞真正的利用方式吧。



首先，该平台在默认情况下存在权限分配问题，需要管理员手动分配对应权限，在默认情况下，很多会泄露敏感信息的API都将暴露给未授权的互联网用户。



以下列表，是我在经过测试后，总结出的可以在默认配置的情况下未授权访问的api接口:

```
#共57条
/api/ce/component
/api/ce/task
/api/ce/task_types
/api/components/app
/api/components/search
/api/components/search_projects
/api/components/suggestions
/api/components/tree
/api/duplications/show
/api/emails/send
/api/issues/changelog
/api/issues/search
/api/measures/component
/api/measures/component_tree
/api/measures/search
/api/measures/search_history
/api/metrics/search
/api/metrics/search
/api/metrics/types
/api/navigation/component
/api/navigation/global
/api/navigation/settings
/api/organizations/search
/api/organizations/search_members
/api/project_badges/measure
/api/project_badges/quality_gate
/api/project_branches/list
/api/project_tags/search
/api/project_tags/search
/api/qualitygates/list
/api/qualitygates/show?id=1
/api/qualityprofiles/importers
/api/qualityprofiles/inheritance
/api/qualityprofiles/search
/api/qualityprofiles/show
/api/rules/list
/api/rules/repositories
/api/rules/search
/api/rules/show
/api/rules/tags
/api/rules/update
/api/server/version
/api/settings/list_definitions
/api/settings/values
/api/sources/index
/api/sources/raw
/api/sources/show
/api/system/db_migration_status
/api/system/migrate_db
/api/system/status
/api/system/upgrades
/api/users/current
/api/users/identity_providers
/api/users/search
/api/webservices/list
/api/webservices/response_example
/batch/project
```



#### 其中有几个值得注意的API接口:


|PATH|Description|Response Contents|Request Parameters 1|Request Parameters 2|Request Parameters 3|Availability after fix|
|----|----|----|----|----|----|:--:|
|/api/server/version|返回应用的版本号|应用版本号||||√|
| /api/settings/values |列出一些设定的值|可能会返回一些敏感信息，但是几率不大||||×|
| /api/users/search |列出活跃的用户|泄露几乎所有的用户列表，可以用于密码爆破||||×|
| /api/webservices/list |列出网络服务|返回一些api目录和api的详细信息||||×|
| /api/components/search_projects |搜索项目|返回敏感信息：organization、Project(ID)、Project(Key)等||||×|
| /api/components/tree |根据所选策略浏览组件|返回大量敏感信息：File(Key)、Project(Key)、Project(ID)等|component：Project(Key)|componentId：Project(ID)||×|
| /api/emails/send |通过发送电子邮件测试电子邮件配置|需要先进行认证，但是认证成功后可以利用配置的邮箱进行钓鱼等横向操作|message：邮件内容|subject：邮件标题|to：目标邮箱|×|
| /api/issues/search |阅读和更新Issues|返回敏感大量信息：issues(key)、File Key(Key)、project(Key)、author(Email)、与其他issues内容信息||||×|
| /api/issues/changelog |显示Issues的变更日志|如果有Issues的变更记录则返回|issue：Issue(key)|||×|
| /api/measures/component_tree |获取具有指定度量的组件或子项|返回大量敏感信息：Project(ID)、File(Key)文件名等|metricKeys：ncloc,complexity,violations|component：Project(Key)|baseComponentId：Project(ID)|×|
| /api/navigation/component |获取有关当前用户的组件导航的信息。|返回少量敏感信息：project(Key)、organization、Project(ID)等|component：Project(Key)|||×|
| /api/rules/list |列出规则，不包括手动规则和状态为 REMOVED 的规则|返回相关API规则信息||||×|
| /api/settings/list_definitions |列出API的设置定义|返回相关API定义内容||||×|
| /batch/project |返回项目存储库|返回指定项目中所有的存储库和文件目录以及其他敏感信息|key：Project(Key)|||×|
| /api/sources/raw |以原始文本形式获取源代码|以原始文本形式获取指定文件的源代码(重点)|key:File(Key)|||×|
| /api/sources/index |获取源代码|获取指定文件的源代码(重点)|key:File(Key)|||×|
| /api/sources/show |以行号/文本对的形式获取源代码|以行号/文本对的形式获取指定文件的源代码(重点)|key:File(Key)|||×|



#### 以下是一些参数的对应内容:

| API                             | 上表对应值    | API返回键    | 注释                                                         |
| ------------------------------- | ------------- | ------------ | ------------------------------------------------------------ |
| /api/components/search_projects | organization  | organization | 所属组织名称                                                 |
| /api/components/search_projects | Project(ID)   | id           | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/components/search_projects | Project(Key)  | key          | 这里的key一般与name单独计算，name是一些项目名称，key则还有可能是文件目录 |
| /api/components/search_projects | File(Key)     | key          | 后期参数需要的key，其格式为:<项目名>:<文件目录>              |
| /api/components/tree            | File(Key)     | component    | 后期参数需要的key，其格式为:<项目名>:<文件目录>              |
| /api/components/tree            | Project(Key)  | project      | 这里的key一般与name单独计算，name是一些项目名称，key则还有可能是文件目录 |
| /api/components/tree            | Project(ID)   | key          | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/issues/search              | issues(key)   | key          | 标识每个issues，每个回复每个问题都有一个                     |
| /api/issues/search              | File (Key)    | component    | 后期参数需要的key，其格式为:<项目名>:<文件目录>              |
| /api/issues/search              | Project(Key)  | project      | 这里的key一般与name单独计算，name是一些项目名称，key则还有可能是文件目录 |
| /api/issues/search              | author(Email) | author       | 发起此issues的用户邮箱，可用于钓鱼                           |
| /api/measures/component_tree    | Project(ID)   | id           | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/measures/component_tree    | File(Key)     | key          | 后期参数需要的key，其格式为:<项目名>:<文件目录>，但是该API存在项目名(根目录) |
| /api/navigation/component       | project(Key)  | key          | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |
| /api/navigation/component       | organization  | organization | 所属组织名称                                                 |
| /api/navigation/component       | Project(ID)   | id           | 项目的唯一标识ID，并非至单一项目，项目中的每个目录、每个文件都拥有一个 |





相信已经有人可以看出一个大概的流程了，通过上诉的API我们大致可以推出一个大致的进攻手法:



#### 一、验证漏洞

通过 ***/api/server/version*** 和 ***/api/settings/values*** 判断目标系统版本号与是否存在漏洞



#### 二、弱口令

通过 ***/api/users/search*** 获取用户列表，对用户密码进行模糊测试



#### 三、源代码泄露

1. 通过 ***/api/components/search_projects*** 获取 ***organization*** 、***Project(ID)***  和 ***Project(Key)*** 等后续需要的信息
2. 通过 ***/api/components/tree*** 或 ***/batch/project***  并代入之前获取的 ***Project(ID)***  和 ***Project(Key)***  参数，获取 ***File(Key)*** ，也就是<项目名>:<文件目录>和其他后续需要的信息
3. 通过 ***/api/sources/raw*** 、 ***/api/sources/index*** 或 ***/api/sources/show*** 并带入之前获取的 ***File(Key)*** 参数，获取目标文件的源代码



#### 四、可能存在的横向移动

1. 通过 ***/api/issues/search*** 获取人员联络方式(邮件)
2. 获取权限后通过 ***/api/emails/send*** 对其人员进行钓鱼攻击



#### fofa指纹

```
app="sonarQube-代码管理"
```



#### 影响

目前fofa上在录资产26245条

经过估算60%的资产存在该漏洞

多个机构遭受该漏洞攻击



#### 相关链接

[CNVD-2021-84502](https://www.cnvd.org.cn/flaw/show/CNVD-2021-84502)

[CVE-2020-27986](https://nvd.nist.gov/vuln/detail/CVE-2020-27986)

